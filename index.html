<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>ë‹¨ì–´ ì™¸ìš°ê¸°</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2b;
      --muted:#93a4c7;
      --text:#e9eefc;
      --accent:#7aa2ff;
      --good:#3ddc97;
      --bad:#ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, Noto Sans KR, Arial, "Helvetica Neue", sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, rgba(122,162,255,.20), transparent 55%),
                  radial-gradient(900px 700px at 100% 0%, rgba(61,220,151,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      padding: calc(14px + var(--safeTop)) 14px calc(88px + var(--safeBottom));
      -webkit-tap-highlight-color: transparent;
    }
    a{color:inherit}
    .app{ max-width: 520px; margin: 0 auto; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:14px;
    }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(122,162,255,.95), rgba(61,220,151,.85));
      box-shadow: var(--shadow);
    }
    .brand h1{font-size:16px;margin:0;line-height:1.1;}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}

    .pill{
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      display:flex;
      gap:8px;
      align-items:center;
      font-size:12px;
      color: var(--muted);
    }

    .grid{ display:grid; grid-template-columns: 1fr; gap:12px; }

    .card{
      background: rgba(18,26,43,.9);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: var(--shadow);
    }

    .card h2{ margin:0 0 6px; font-size:14px; letter-spacing:-.2px; }
    .card .sub{ font-size:12px; color: var(--muted); margin:0 0 12px; line-height:1.4; }

    .tiles{ display:grid; grid-template-columns: 1fr; gap:10px; }
    .tile{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px;
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      text-decoration:none;
    }
    .tile strong{font-size:14px;}
    .tile span{font-size:12px; color:var(--muted)}
    .badge{
      min-width: 38px;
      padding:6px 10px;
      border-radius: 999px;
      text-align:center;
      font-weight:700;
      font-size:12px;
      background: rgba(122,162,255,.20);
      border:1px solid rgba(122,162,255,.35);
      color: #dbe6ff;
    }

    .langBar{
      display:flex;
      gap:8px;
      margin-bottom:12px;
    }
    .langBtn{
      flex:1;
      padding:10px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight:800;
      font-size:12px;
    }
    .langBtn.active{
      color: var(--text);
      border-color: rgba(122,162,255,.45);
      background: rgba(122,162,255,.14);
    }

    .nav{
      position: fixed;
      left:0; right:0;
      bottom:0;
      padding: 10px 14px calc(10px + var(--safeBottom));
      background: rgba(11,18,32,.75);
      backdrop-filter: blur(14px);
      border-top:1px solid rgba(255,255,255,.08);
    }
    .nav .wrap{
      max-width:520px;
      margin:0 auto;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .nav button{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      color: var(--muted);
      border-radius: 14px;
      padding:10px 8px;
      font-size:12px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
    }
    .nav button.active{
      color: var(--text);
      border-color: rgba(122,162,255,.45);
      background: rgba(122,162,255,.14);
    }

    /* Today swipe UI */
    .stack{ position: relative; height: 430px; margin-top: 12px; }
    .wordCard{
      position:absolute;
      inset:0;
      padding:16px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(18,26,43,.94), rgba(18,26,43,.86));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      transform: translateY(0) scale(1);
      touch-action: pan-y;
      user-select:none;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      overflow:hidden;
    }
    .wordCard::before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(700px 340px at 20% 0%, rgba(122,162,255,.24), transparent 55%),
                  radial-gradient(700px 340px at 80% 0%, rgba(61,220,151,.18), transparent 55%);
      opacity:.9;
      z-index:0;
    }
    .wordCard > *{ position:relative; z-index:1; }

    .wcTop{display:flex; justify-content:space-between; align-items:flex-start; gap:10px;}
    .wcIndex{font-size:12px; color:var(--muted)}
    .wcHint{font-size:12px; color:var(--muted); text-align:right; line-height:1.35}

    .wcMain{margin-top:10px;}
    .wcWordRow{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .wcWord{font-size:32px; letter-spacing:-.6px; margin:0;}

    .ttsBtn{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 10px;
      font-size:12px;
      font-weight:900;
      line-height:1;
      min-width:44px;
    }

    .wcIpa{margin:6px 0 0; color:#cfe0ff; font-size:14px; opacity:.95}
    .wcKo{margin:6px 0 0; color:var(--muted); font-size:13px; opacity:.95}
    .wcMeaning{margin:8px 0 0; color: var(--text); font-size:14px; opacity:.95; line-height:1.45}

    /* Meaning mask (tap to reveal) */
    .mask{
      display:inline-block;
      padding:8px 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
    }
    .mask::after{
      content:"íƒ­í•´ì„œ ëœ» ë³´ê¸°";
      display:block;
      margin-top:6px;
      font-size:11px;
      color: var(--muted);
      opacity:.9;
    }
    .mask.revealed::after{ content:""; margin:0; }
    .mask:not(.revealed){
      filter: blur(8px);
      opacity: .85;
    }
    .mask.revealed{
      filter:none;
      opacity:1;
    }

    .wcExample{
      margin:12px 0 0;
      color:var(--text);
      font-size:14px;
      line-height:1.55;
      text-decoration: underline;
      text-underline-offset: 4px;
      opacity:.95;
      cursor:pointer;
    }

    .wcActions{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top: 14px;}
    .btn{
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:700;
      font-size:13px;
    }
    .btn.good{background: rgba(61,220,151,.14); border-color: rgba(61,220,151,.35)}
    .btn.bad{background: rgba(255,107,107,.12); border-color: rgba(255,107,107,.32)}

    .empty{ text-align:center; padding:30px 16px; color:var(--muted); line-height:1.6; }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .row{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:12px;
      border-radius:16px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
    }
    .rowTop{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .rowWord{font-size:16px; font-weight:800; letter-spacing:-.2px}
    .rowIpa{font-size:12px; color:#cfe0ff; opacity:.9}
    .rowKo{font-size:12px; color:var(--muted)}
    .rowMeaning{font-size:13px; color: var(--text); opacity:.92; line-height:1.45}
    .rowEx{font-size:13px; color:var(--text); opacity:.92; line-height:1.45; text-decoration:underline; text-underline-offset:3px; cursor:pointer;}
    .rowMeta{font-size:11px; color:var(--muted)}

    .toolbar{ display:flex; gap:10px; align-items:center; margin-top:10px; }
    .toolbar .btn{flex:1}

    .notice{
      background: rgba(122,162,255,.12);
      border:1px solid rgba(122,162,255,.28);
      color: #dbe6ff;
      padding:12px;
      border-radius: 16px;
      line-height:1.5;
      font-size:12px;
    }

    textarea{
      width:100%;
      min-height: 160px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:12px;
      font-size:12px;
      line-height:1.4;
      outline:none;
    }
    input{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:12px;
      font-size:13px;
      outline:none;
    }
    .small{font-size:12px;color:var(--muted);line-height:1.5;margin:10px 0 0}

    /* Modal (example detail) */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 12px 14px calc(12px + var(--safeBottom));
      z-index: 999;
    }
    .modalOverlay.show{ display:flex; }
    .modalSheet{
      width:100%;
      max-width:520px;
      border-radius: 22px;
      background: rgba(18,26,43,.97);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .modalTop{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px;}
    .modalTop strong{font-size:14px;}
    .xBtn{min-width:44px;}

    @media (min-width: 430px){
      .tiles{grid-template-columns: 1fr 1fr;}
      .nav .wrap{gap:12px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>ë‹¨ì–´ ì™¸ìš°ê¸°</h1>
          <p id="subtitle">ì˜¤ëŠ˜ì˜ ë‹¨ì–´ 30ê°œ Â· ìŠ¤ì™€ì´í”„ë¡œ ë¶„ë¥˜</p>
        </div>
      </div>
      <div class="pill" id="todayPill">ğŸ“… <span id="todayStr"></span></div>
    </div>

    <main id="view"></main>
  </div>

  <div class="nav" role="navigation" aria-label="í•˜ë‹¨ ë©”ë‰´">
    <div class="wrap">
      <button data-route="home" class="active">ğŸ <div>ë©”ì¸</div></button>
      <button data-route="today">ğŸ”¥<div>ì˜¤ëŠ˜</div></button>
      <button data-route="unknown">â“<div>ëª¨ë¥´ëŠ”</div></button>
      <button data-route="known">âœ…<div>ì•„ëŠ”</div></button>
    </div>
  </div>

<script>
(async () => {
  /**
   * âœ… ìˆ˜ì •/ì¶”ê°€ëœ í•µì‹¬
   * 1) ë°°í¬ìš© ê¸°ë³¸ ë‹¨ì–´íŒ© ìë™ ë¡œë“œ:
   *    - vocab_en.json / vocab_ja.json / vocab_es.json (ìˆìœ¼ë©´ ìë™ ì €ì¥)
   * 2) ë‹¨ì–´ 0ê°œë©´ í”Œëœ ìƒì„±/ë‚´ì¼ íƒ­ í‘œì‹œ ê¸ˆì§€ (ì˜¤ë¥˜ ë°©ì§€)
   */

  const LS_KEY = 'vocab_swipe_v2_multi_lang';
  const LS_CUSTOM_MASTER_PREFIX = 'vocab_custom_master_v2_';

  const LANGS = {
    en: { label: 'English', tts: 'en-US', defaultFile: './vocab_en.json' },
    ja: { label: 'æ—¥æœ¬èª', tts: 'ja-JP', defaultFile: './vocab_ja.json' },
    es: { label: 'EspaÃ±ol', tts: 'es-ES', defaultFile: './vocab_es.json' }
  };

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  const now = () => Date.now();
  const pad2 = (n) => String(n).padStart(2,'0');
  const isoDate = (d=new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const formatKDate = (d=new Date()) => `${d.getFullYear()}.${pad2(d.getMonth()+1)}.${pad2(d.getDate())}`;
  const daysBetween = (aMs, bMs) => Math.floor((bMs - aMs) / (1000*60*60*24));

  function seededRandom(seedStr){
    function xmur3(str){
      let h = 1779033703 ^ str.length;
      for (let i=0; i<str.length; i++){
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = (h << 13) | (h >>> 19);
      }
      return function(){
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        return (h ^= h >>> 16) >>> 0;
      }
    }
    function mulberry32(a){
      return function(){
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      }
    }
    const seed = xmur3(seedStr)();
    return mulberry32(seed);
  }

  function shuffle(arr, rnd){
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--){
      const j = Math.floor(rnd() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function hashId(s){
    let h = 0;
    for (let i=0;i<s.length;i++) h = Math.imul(31,h) + s.charCodeAt(i) | 0;
    return Math.abs(h).toString(36);
  }

  function escapeHtml(s){
    return String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  // ---------- Built-in masters (ìƒ˜í”Œ/ì´ˆê¸°ê°’) ----------
  const builtIn = {
    en: [
      {id:'en_1', word:'account', ipa:'/É™ËˆkaÊŠnt/', koPron:'ì–´ì¹´ìš´íŠ¸', meaningKo:'ê³„ì •, ì„¤ëª…', example:'I created an account to track my expenses.'},
      {id:'en_2', word:'achieve', ipa:'/É™ËˆtÊƒiËv/', koPron:'ì–´ì¹˜ë¸Œ', meaningKo:'ë‹¬ì„±í•˜ë‹¤', example:'Small habits help you achieve big goals.'},
      {id:'en_3', word:'clarify', ipa:'/ËˆklÃ¦rÉªfaÉª/', koPron:'í´ë˜ëŸ¬íŒŒì´', meaningKo:'ëª…í™•íˆ í•˜ë‹¤', example:'Could you clarify what you mean?'},
      {id:'en_4', word:'reliable', ipa:'/rÉªËˆlaÉªÉ™bÉ™l/', koPron:'ë¦´ë¼ì´ì–´ë¸”', meaningKo:'ë¯¿ì„ ìˆ˜ ìˆëŠ”', example:'This brand is reliable.'},
      {id:'en_5', word:'schedule', ipa:'/ËˆskÉ›dÊ’uËl/ (US), /ËˆÊƒÉ›djuËl/ (UK)', koPron:'ìŠ¤ì¼€ì¤„', meaningKo:'ì¼ì •', example:'My work schedule changes every week.'}
    ],
    ja: [
      {id:'ja_1', word:'ç¢ºèª', ipa:'ï¼ˆã‹ãã«ã‚“ï¼‰', koPron:'ì¹´ì¿ ë‹Œ', meaningKo:'í™•ì¸', example:'ã‚‚ã†ä¸€åº¦ã€ç¢ºèªã—ã¦ãã ã•ã„ã€‚'},
      {id:'ja_2', word:'äºˆç´„', ipa:'ï¼ˆã‚ˆã‚„ãï¼‰', koPron:'ìš”ì•¼ì¿ ', meaningKo:'ì˜ˆì•½', example:'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚’äºˆç´„ã—ã¾ã—ãŸã€‚'},
      {id:'ja_3', word:'ä¾¿åˆ©', ipa:'ï¼ˆã¹ã‚“ã‚Šï¼‰', koPron:'ë²¤ë¦¬', meaningKo:'í¸ë¦¬í•¨, í¸ë¦¬í•œ', example:'ã‚¹ãƒãƒ›ã¯ã¨ã¦ã‚‚ä¾¿åˆ©ã§ã™ã€‚'},
      {id:'ja_4', word:'å¤§ä¸ˆå¤«', ipa:'ï¼ˆã ã„ã˜ã‚‡ã†ã¶ï¼‰', koPron:'ë‹¤ì´ì£ ë¶€', meaningKo:'ê´œì°®ì•„, ë¬¸ì œì—†ì–´', example:'å¤§ä¸ˆå¤«ï¼Ÿæ‰‹ä¼ãŠã†ã‹ï¼Ÿ'},
      {id:'ja_5', word:'çµŒé¨“', ipa:'ï¼ˆã‘ã„ã‘ã‚“ï¼‰', koPron:'ì¼€ì´ì¼„', meaningKo:'ê²½í—˜', example:'ã„ã„çµŒé¨“ã«ãªã‚Šã¾ã—ãŸã€‚'}
    ],
    es: [
      {id:'es_1', word:'cuenta', ipa:'[Ëˆkwenta]', koPron:'ì¿ ì—”íƒ€', meaningKo:'ê³„ì •, ê³„ì‚°ì„œ', example:'AbrÃ­ una cuenta para ahorrar dinero.'},
      {id:'es_2', word:'lograr', ipa:'[loËˆÉ£É¾aÉ¾]', koPron:'ë¡œê·¸ë¼ë¥´', meaningKo:'ë‹¬ì„±í•˜ë‹¤', example:'Puedes lograr tus metas con constancia.'},
      {id:'es_3', word:'aclarar', ipa:'[aklaËˆÉ¾aÉ¾]', koPron:'ì•„í´ë¼ë¼ë¥´', meaningKo:'ëª…í™•íˆ í•˜ë‹¤', example:'Â¿Puedes aclarar tu idea?'},
      {id:'es_4', word:'fiable', ipa:'[Ëˆfjable]', koPron:'í”¼ì•„ë¸”ë ˆ', meaningKo:'ë¯¿ì„ ìˆ˜ ìˆëŠ”', example:'Este coche es muy fiable.'},
      {id:'es_5', word:'horario', ipa:'[oËˆÉ¾aÉ¾jo]', koPron:'ì˜¤ë¼ë¦¬ì˜¤', meaningKo:'ì‹œê°„í‘œ, ì¼ì •', example:'Mi horario cambia cada semana.'}
    ]
  };

  function loadCustomMaster(lang){
    try{
      const raw = localStorage.getItem(LS_CUSTOM_MASTER_PREFIX + lang);
      if(!raw) return null;
      const parsed = JSON.parse(raw);
      if(!Array.isArray(parsed) || parsed.length === 0) return null;
      const ok = parsed.every(x => x && typeof x.word === 'string' && typeof x.example === 'string');
      if(!ok) return null;
      return parsed.map((x, idx) => ({
        id: x.id ?? `c_${lang}_${idx}_${hashId(x.word)}`,
        word: x.word.trim(),
        ipa: (x.ipa ?? '').trim(),
        koPron: (x.koPron ?? x.koreanPron ?? x.krPron ?? '').trim(),
        meaningKo: (x.meaningKo ?? x.meaning ?? x.krMeaning ?? '').trim(),
        example: x.example.trim()
      }));
    }catch{ return null; }
  }

  function saveCustomMaster(lang, list){
    localStorage.setItem(LS_CUSTOM_MASTER_PREFIX + lang, JSON.stringify(list));
  }

  function getMaster(lang){
    return loadCustomMaster(lang) ?? builtIn[lang] ?? [];
  }

  // ---------- State (ì–¸ì–´ë³„ë¡œ ì§„í–‰ ì €ì¥) ----------
  function defaultLangState(){
    return {
      known: {},
      unknown: {},
      daily: {},
      settings: { rewindDays: 7, dailyCount: 30 },
      plan: null
    };
  }

  function defaultState(){
    return {
      schemaVersion: 2,
      activeLang: 'en',
      langs: {
        en: defaultLangState(),
        ja: defaultLangState(),
        es: defaultLangState()
      }
    };
  }

  function migrateIfNeeded(s){
    if(!s) return defaultState();
    if(s.schemaVersion === 2 && s.langs) return s;

    const next = defaultState();
    try{
      if(s.known || s.unknown || s.daily || s.settings){
        next.langs.en = {
          ...defaultLangState(),
          known: s.known ?? {},
          unknown: s.unknown ?? {},
          daily: s.daily ?? {},
          settings: { ...next.langs.en.settings, ...(s.settings ?? {}) }
        };
      }
    }catch{}
    return next;
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return defaultState();
      const parsed = JSON.parse(raw);
      return migrateIfNeeded(parsed);
    }catch{ return defaultState(); }
  }

  let state = loadState();
  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  function langState(){
    state.langs[state.activeLang] ??= defaultLangState();
    return state.langs[state.activeLang];
  }

  function activeLangMeta(){ return LANGS[state.activeLang] ?? LANGS.en; }

  // âœ… ë°°í¬ìš© ê¸°ë³¸ ë‹¨ì–´íŒ© ìë™ ë¡œë“œ (ì²˜ìŒ 1íšŒ)
  async function loadDefaultPackIfMissing(lang){
    const meta = LANGS[lang];
    if(!meta?.defaultFile) return false;

    // ì´ë¯¸ ì»¤ìŠ¤í…€ ë‹¨ì–´ê°€ ìˆìœ¼ë©´ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
    if(localStorage.getItem(LS_CUSTOM_MASTER_PREFIX + lang)) return false;

    try{
      const res = await fetch(meta.defaultFile, { cache: 'no-store' });
      if(!res.ok) return false;
      const data = await res.json();
      if(!Array.isArray(data) || data.length === 0) return false;

      // normalize
      const normalized = data.map((x, idx) => ({
        id: x.id ?? `f_${lang}_${idx}_${hashId(x.word ?? '')}`,
        word: String(x.word ?? '').trim(),
        ipa: String(x.ipa ?? '').trim(),
        koPron: String(x.koPron ?? '').trim(),
        meaningKo: String(x.meaningKo ?? '').trim(),
        example: String(x.example ?? '').trim()
      })).filter(x => x.word && x.example);

      if(normalized.length === 0) return false;

      saveCustomMaster(lang, normalized);

      // í”Œëœì€ ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸ ê¸°ë°˜ì´ë‹ˆê¹Œ ìƒˆë¡œ ìƒì„±ë˜ë„ë¡ ë¦¬ì…‹
      state.langs[lang] ??= defaultLangState();
      state.langs[lang].plan = null;
      saveState();

      return true;
    }catch{
      return false;
    }
  }

  // ---------- TTS ----------
  function speak(text){
    try{
      if(!('speechSynthesis' in window)){
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” TTSë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„.');
        return;
      }
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = activeLangMeta().tts;
      u.rate = 0.95;
      u.pitch = 1.0;
      window.speechSynthesis.speak(u);
    }catch{
      alert('TTS ì¬ìƒì— ì‹¤íŒ¨í–ˆì–´.');
    }
  }

  // ---------- Modal (example detail) ----------
  function ensureModal(){
    if($('#modalOverlay')) return;
    const overlay = document.createElement('div');
    overlay.id = 'modalOverlay';
    overlay.className = 'modalOverlay';
    overlay.innerHTML = `
      <div class="modalSheet" role="dialog" aria-modal="true">
        <div class="modalTop">
          <strong id="mTitle">ìƒì„¸</strong>
          <button class="ttsBtn xBtn" id="mClose" aria-label="ë‹«ê¸°">âœ•</button>
        </div>
        <div id="mBody"></div>
      </div>
    `;
    document.body.appendChild(overlay);

    overlay.addEventListener('click', (e) => {
      if(e.target === overlay) closeModal();
    });
    $('#mClose', overlay).addEventListener('click', closeModal);
  }

  function openModal(word){
    ensureModal();
    $('#mTitle').textContent = `${word.word}`;
    $('#mBody').innerHTML = `
      <div style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
        <div>
          <div class="rowIpa">${escapeHtml(word.ipa || '')}</div>
          <div class="rowKo">ë°œìŒ(í•œê¸€): ${escapeHtml(word.koPron || '-')}</div>
          <div class="rowMeaning mask" data-mask="meaning">ëœ»: ${escapeHtml(word.meaningKo || '-')}</div>
        </div>
        <button class="ttsBtn" id="mSpeakWord">ğŸ”Š</button>
      </div>
      <div style="margin-top:12px;">
        <div class="rowEx" id="mExample">${escapeHtml(word.example || '')}</div>
        <div class="small">ì˜ˆë¬¸ì„ ëˆ„ë¥´ë©´ TTSê°€ ì¬ìƒë¼.</div>
      </div>
    `;
    $('#mSpeakWord').addEventListener('click', () => speak(word.word));
    $('#mExample').addEventListener('click', () => speak(word.example));
    initMasking($('#mBody'));

    $('#modalOverlay').classList.add('show');
  }

  function closeModal(){
    $('#modalOverlay')?.classList.remove('show');
  }

  // ---------- Routing ----------
  const routes = {
    home: renderHome,
    today: () => renderDay(isoDate(), 'today'),
    tomorrow: () => renderDay(addDaysIso(isoDate(), 1), 'tomorrow'),
    unknown: renderUnknown,
    known: renderKnown,
    settings: renderSettings
  };
  let currentRoute = 'home';

  function setRoute(route){
    currentRoute = route;
    $$('.nav button').forEach(b => b.classList.toggle('active', b.dataset.route === route));
    routes[route]?.();
  }

  // Top date pill
  $('#todayStr').textContent = formatKDate(new Date());

  function countKnown(){ return Object.keys(langState().known).length; }
  function countUnknown(){ return Object.keys(langState().unknown).length; }

  // ---- 30ì¼ í”Œëœ (ë‚ ì§œë³„ë¡œ 30ê°œì”© ê³ ì •) ----
  function addDaysIso(dateStr, add){
    const [y,m,d] = dateStr.split('-').map(Number);
    const dt = new Date(y, m-1, d);
    dt.setDate(dt.getDate() + add);
    return isoDate(dt);
  }

  function ensurePlan(){
    const ls = langState();
    const master = getMaster(state.activeLang);

    // âœ… ë‹¨ì–´ê°€ 0ê°œë©´ í”Œëœì„ ë§Œë“¤ì§€ ì•ŠìŒ(ì˜¤ë¥˜ ë°©ì§€)
    if(master.length === 0){
      ls.plan = null;
      saveState();
      return;
    }

    // ì´ë¯¸ í”Œëœì´ ìˆê³ , dailyCountê°€ ê°™ê³ , masterCountê°€ ê°™ìœ¼ë©´ ìœ ì§€
    const dailyCount = ls.settings.dailyCount;
    const signature = `${state.activeLang}|${dailyCount}|${master.length}`;
    if(ls.plan && ls.plan.signature === signature && ls.plan.startDate && ls.plan.days) return;

    const totalNeed = dailyCount * 30;
    const startDate = isoDate();
    const rnd = seededRandom(`plan|${signature}|${startDate}`);

    const ids = master.map(w => w.id);
    const shuffled = shuffle(ids, rnd);

    let pool = shuffled.slice();
    if(pool.length < totalNeed){
      const times = Math.ceil(totalNeed / pool.length);
      pool = Array.from({length: times}, () => shuffled).flat().slice(0, totalNeed);
    } else {
      pool = pool.slice(0, totalNeed);
    }

    const days = {};
    for(let i=0;i<30;i++){
      const dayDate = addDaysIso(startDate, i);
      const chunk = pool.slice(i*dailyCount, (i+1)*dailyCount);
      days[dayDate] = chunk;
    }

    ls.plan = { startDate, days, signature };
    saveState();
  }

  function getPlannedList(dateStr){
    ensurePlan();
    const ls = langState();
    const master = getMaster(state.activeLang);

    // í”Œëœì´ ì—†ê±°ë‚˜ í•´ë‹¹ ë‚ ì§œê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´
    const ids = ls.plan?.days?.[dateStr] ?? [];
    return ids.map(id => master.find(w => w.id === id)).filter(Boolean);
  }

  function hasPlanDay(dateStr){
    // âœ… â€œí‚¤ë§Œ ìˆìŒâ€ì´ ì•„ë‹ˆë¼ â€œì‹¤ì œ ë‹¨ì–´ê°€ 1ê°œ ì´ìƒâ€ì¼ ë•Œë§Œ true
    const list = getPlannedList(dateStr);
    return list.length > 0;
  }

  function getDailyProgress(dateStr){
    const ls = langState();
    ls.daily[dateStr] ??= { doneIds: [], knownIds: [], unknownIds: [] };
    return ls.daily[dateStr];
  }

  function markKnown(word, dateStr){
    const ls = langState();
    const t = now();
    ls.known[word.id] ??= { firstAt: t, lastReviewedAt: t, fromDate: dateStr };
    ls.known[word.id].lastReviewedAt = t;
    if(ls.unknown[word.id]) delete ls.unknown[word.id];

    const dp = getDailyProgress(dateStr);
    if(!dp.doneIds.includes(word.id)) dp.doneIds.push(word.id);
    if(!dp.knownIds.includes(word.id)) dp.knownIds.push(word.id);
    dp.unknownIds = dp.unknownIds.filter(id => id !== word.id);
    saveState();
  }

  function markUnknown(word, dateStr){
    const ls = langState();
    const t = now();
    ls.unknown[word.id] ??= { firstAt: t, lastSeenAt: t, fromDate: dateStr };
    ls.unknown[word.id].lastSeenAt = t;

    const dp = getDailyProgress(dateStr);
    if(!dp.doneIds.includes(word.id)) dp.doneIds.push(word.id);
    if(!dp.unknownIds.includes(word.id)) dp.unknownIds.push(word.id);
    dp.knownIds = dp.knownIds.filter(id => id !== word.id);
    saveState();
  }

  function unmark(wordId, target){
    const ls = langState();
    if(target === 'known'){ delete ls.known[wordId]; }
    if(target === 'unknown'){ delete ls.unknown[wordId]; }
    saveState();
    routes[currentRoute]?.();
  }

  function getRewindDueIds(){
    const ls = langState();
    const due = [];
    const cutoffDays = ls.settings.rewindDays;
    const t = now();
    for(const id of Object.keys(ls.known)){
      const last = ls.known[id]?.lastReviewedAt ?? 0;
      if(last === 0 || daysBetween(last, t) >= cutoffDays) due.push(id);
    }
    return due;
  }

  // ---------- Views ----------
  function renderHome(){
    const ls = langState();
    const langLabel = activeLangMeta().label;
    $('#subtitle').textContent = `${langLabel} Â· ì˜¤ëŠ˜ì˜ ë‹¨ì–´ ${ls.settings.dailyCount}ê°œ Â· ìŠ¤ì™€ì´í”„ë¡œ ë¶„ë¥˜`;

    const todayStr = isoDate();
    const dp = getDailyProgress(todayStr);
    const done = dp.doneIds.length;
    const total = ls.settings.dailyCount;
    const due = getRewindDueIds().length;

    const tomorrowStr = addDaysIso(todayStr, 1);
    const showTomorrow = (done >= total) && hasPlanDay(tomorrowStr);

    const masterCount = getMaster(state.activeLang).length;

    $('#view').innerHTML = `
      <div class="grid">
        <div class="card">
          <h2>ì–¸ì–´ ì„ íƒ</h2>
          <p class="sub">ë©”ì¸ì—ì„œ ì–¸ì–´ë¥¼ ê³ ë¥´ë©´, ê·¸ ì–¸ì–´ì˜ ë‹¨ì–´/ê¸°ë¡ì„ ë”°ë¡œ ê´€ë¦¬í•´.</p>
          <div class="langBar">
            <button class="langBtn" data-lang="en">ì˜ì–´</button>
            <button class="langBtn" data-lang="ja">ì¼ë³¸ì–´</button>
            <button class="langBtn" data-lang="es">ìŠ¤í˜ì¸ì–´</button>
          </div>
          <div class="notice">í˜„ì¬ ì„ íƒ: <b>${escapeHtml(langLabel)}</b> Â· ë‹¨ì–´ ìˆ˜: <b>${masterCount}</b>ê°œ</div>
        </div>

        <div class="card">
          <h2>ì˜¤ëŠ˜ ì§„í–‰ë¥ </h2>
          <p class="sub">ì˜¤ëŠ˜(${formatKDate(new Date())}) ë‹¨ì–´ ${total}ê°œ ì¤‘ <b>${done}</b>ê°œ ë¶„ë¥˜í–ˆì–´ìš”.</p>

          ${masterCount === 0 ? `
            <div class="notice">
              âš ï¸ í˜„ì¬ ì–¸ì–´ì˜ ë‹¨ì–´ ëª©ë¡ì´ ë¹„ì–´ ìˆì–´ìš”.<br/>
              ê°™ì€ í´ë”ì— <b>${escapeHtml(activeLangMeta().defaultFile)}</b> íŒŒì¼ì„ ì˜¬ë¦¬ê±°ë‚˜, ì„¤ì •ì—ì„œ ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ì¤˜.
            </div>
          ` : ``}

          <div class="tiles">
            <a class="tile" href="#" data-go="today">
              <div>
                <strong>ğŸ”¥ ì˜¤ëŠ˜ì˜ ë‹¨ì–´</strong>
                <div><span>ë‹¨ì–´ Â· IPA Â· í•œê¸€ë°œìŒ Â· ëœ» Â· ì˜ˆë¬¸</span></div>
              </div>
              <div class="badge">${Math.min(total, masterCount)}</div>
            </a>

            ${showTomorrow ? `
              <a class="tile" href="#" data-go="tomorrow">
                <div>
                  <strong>â­ï¸ ë‚´ì¼ì˜ ë‹¨ì–´</strong>
                  <div><span>ì˜¤ëŠ˜ì„ ëë‚´ë©´ ì—´ë ¤ìš”</span></div>
                </div>
                <div class="badge">${Math.min(total, masterCount)}</div>
              </a>
            ` : ``}

            <a class="tile" href="#" data-go="unknown">
              <div>
                <strong>â“ ëª¨ë¥´ëŠ” ë‹¨ì–´</strong>
                <div><span>ë‹¤ì‹œ ë³´ê¸° / ë³µìŠµ</span></div>
              </div>
              <div class="badge">${countUnknown()}</div>
            </a>
            <a class="tile" href="#" data-go="known">
              <div>
                <strong>âœ… ì•„ëŠ” ë‹¨ì–´</strong>
                <div><span>${ls.settings.rewindDays}ì¼ë§ˆë‹¤ ë¦¬ì™€ì¸ë“œ</span></div>
              </div>
              <div class="badge">${countKnown()}</div>
            </a>
            <a class="tile" href="#" data-go="settings">
              <div>
                <strong>âš™ï¸ ì„¤ì •</strong>
                <div><span>ë‹¨ì–´ì¶”ê°€/ëª©ë¡/ì´ˆê¸°í™”</span></div>
              </div>
              <div class="badge">${due}</div>
            </a>
          </div>

          ${due > 0 ? `<div class="notice" style="margin-top:12px;">âœ… ë¦¬ì™€ì¸ë“œ ëŒ€ìƒ ë‹¨ì–´ê°€ <b>${due}</b>ê°œ ìˆì–´ìš”. (ì•„ëŠ” ë‹¨ì–´ â†’ ë¦¬ì™€ì¸ë“œ)</div>` : ``}
        </div>

        <div class="card">
          <h2>ì‚¬ìš©ë²•</h2>
          <p class="sub">ë‹¨ì–´ ì¹´ë“œì—ì„œ</p>
          <div class="notice">
            â—€ï¸ <b>ì™¼ìª½ ìŠ¤ì™€ì´í”„</b> = <b>ì•„ëŠ” ë‹¨ì–´</b><br/>
            â–¶ï¸ <b>ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„</b> = <b>ëª¨ë¥´ëŠ” ë‹¨ì–´</b><br/>
            <b>ğŸ”Š</b> ë²„íŠ¼: TTS ë°œìŒ ì¬ìƒ<br/>
            <b>ì˜ˆë¬¸ í´ë¦­</b>: ë°œìŒ(í•œê¸€) / ëœ» / TTS í¬í•¨ ìƒì„¸ë³´ê¸°
          </div>
        </div>
      </div>
    `;

    $$('.langBtn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.lang === state.activeLang);
      btn.addEventListener('click', async () => {
        state.activeLang = btn.dataset.lang;
        saveState();

        // ì–¸ì–´ ë°”ê¾¸ë©´ ê·¸ ì–¸ì–´ ê¸°ë³¸íŒ©ë„ ìˆìœ¼ë©´ ìë™ ë¡œë“œ(ì²˜ìŒ 1íšŒ)
        await loadDefaultPackIfMissing(state.activeLang);

        renderHome();
      });
    });

    $$('[data-go]').forEach(el => el.addEventListener('click', (e) => {
      e.preventDefault();
      setRoute(el.dataset.go);
    }));
  }

  function renderDay(dateStr, kind){
    const ls = langState();
    const langLabel = activeLangMeta().label;

    const daily = getPlannedList(dateStr);
    const title = (kind === 'tomorrow') ? 'ë‚´ì¼ì˜ ë‹¨ì–´' : 'ì˜¤ëŠ˜ì˜ ë‹¨ì–´';
    $('#subtitle').textContent = `${langLabel} Â· ${title} Â· ìŠ¤ì™€ì´í”„ë¡œ ë¶„ë¥˜`;

    // âœ… ë‹¨ì–´ê°€ ì—†ìœ¼ë©´ ì•ˆë‚´
    if(daily.length === 0){
      $('#view').innerHTML = `
        <div class="card">
          <h2>${title}</h2>
          <p class="sub">ë‹¨ì–´ ëª©ë¡ì´ ë¹„ì–´ ìˆì–´ì„œ ì˜¤ëŠ˜ì˜ ë‹¨ì–´ë¥¼ ë§Œë“¤ ìˆ˜ ì—†ì–´ìš”.</p>
          <div class="notice">
            ê°™ì€ í´ë”ì— <b>${escapeHtml(activeLangMeta().defaultFile)}</b> íŒŒì¼ì„ ì˜¬ë¦¬ê±°ë‚˜,<br/>
            ì„¤ì •(âš™ï¸)ì—ì„œ ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ì¤˜.
          </div>
          <div class="toolbar">
            <button class="btn" id="goSettings">ì„¤ì •ìœ¼ë¡œ ê°€ê¸°</button>
            <button class="btn" id="goHome">ë©”ì¸</button>
          </div>
        </div>
      `;
      $('#goSettings').addEventListener('click', () => setRoute('settings'));
      $('#goHome').addEventListener('click', () => setRoute('home'));
      return;
    }

    const dp = getDailyProgress(dateStr);
    const doneSet = new Set(dp.doneIds);
    const queue = daily.filter(w => !doneSet.has(w.id));

    const todayStr = isoDate();
    const isToday = dateStr === todayStr;

    $('#view').innerHTML = `
      <div class="card">
        <h2>${title}</h2>
        <p class="sub">${isToday ? 'ì˜¤ëŠ˜' : 'ë‚ ì§œ'}(${escapeHtml(dateStr)}) Â· ì´ ${daily.length}ê°œ Â· ë‚¨ì€ ${queue.length}ê°œ Â· ì™„ë£Œ ${dp.doneIds.length}ê°œ</p>
        ${queue.length === 0 ? `
          <div class="empty">
            ğŸ‰ ${title}ë¥¼ ëª¨ë‘ ë¶„ë¥˜í–ˆì–´!
          </div>
          <div class="toolbar">
            ${isToday ? `<button class="btn" id="btnResetToday">ì˜¤ëŠ˜ ë‹¤ì‹œ í•˜ê¸°</button>` : `<button class="btn" id="btnResetThat">ì´ ë‚ ì§œ ë‹¤ì‹œ í•˜ê¸°</button>`}
            ${isToday ? `<button class="btn" id="btnGoTomorrow" ${hasPlanDay(addDaysIso(dateStr,1)) ? '' : 'disabled'}>ë‚´ì¼ì˜ ë‹¨ì–´</button>` : `<button class="btn" id="btnGoUnknown">ëª¨ë¥´ëŠ” ë‹¨ì–´</button>`}
          </div>
        ` : `
          <div class="stack" id="stack"></div>
          <div class="small">íŒ: ì™¼ìª½=ì•„ëŠ” ë‹¨ì–´, ì˜¤ë¥¸ìª½=ëª¨ë¥´ëŠ” ë‹¨ì–´ Â· ëœ» íƒ­=í•´ì œ Â· ì˜ˆë¬¸ í´ë¦­=ìƒì„¸ë³´ê¸°</div>
        `}
      </div>
    `;

    if(queue.length === 0){
      const resetBtn = $('#btnResetToday') || $('#btnResetThat');
      resetBtn?.addEventListener('click', () => {
        ls.daily[dateStr] = { doneIds: [], knownIds: [], unknownIds: [] };
        saveState();
        renderDay(dateStr, kind);
      });
      $('#btnGoUnknown')?.addEventListener('click', () => setRoute('unknown'));
      $('#btnGoTomorrow')?.addEventListener('click', () => setRoute('tomorrow'));
      return;
    }

    const stack = $('#stack');
    const maxCards = Math.min(3, queue.length);
    const visible = queue.slice(0, maxCards);

    visible.forEach((w, idx) => {
      const card = document.createElement('div');
      card.className = 'wordCard';
      card.style.transform = `translateY(${idx*8}px) scale(${1 - idx*0.02})`;
      card.style.opacity = `${1 - idx*0.08}`;
      card.style.zIndex = String(10 - idx);

      card.innerHTML = `
        <div>
          <div class="wcTop">
            <div class="wcIndex">${dp.doneIds.length + 1} / ${daily.length}</div>
            <div class="wcHint">â—€ï¸ ì•„ëŠ” ë‹¨ì–´<br/>â–¶ï¸ ëª¨ë¥´ëŠ” ë‹¨ì–´</div>
          </div>
          <div class="wcMain">
            <div class="wcWordRow">
              <h3 class="wcWord">${escapeHtml(w.word)}</h3>
              <button class="ttsBtn" data-tts="word" aria-label="ë‹¨ì–´ ë°œìŒ">ğŸ”Š</button>
            </div>
            <div class="wcIpa">${escapeHtml(w.ipa || '')}</div>
            <div class="wcKo">ë°œìŒ(í•œê¸€): ${escapeHtml(w.koPron || '-')}</div>
            <div class="wcMeaning mask" data-mask="meaning">ëœ»: ${escapeHtml(w.meaningKo || '-')}</div>
            <div class="wcExample" data-open="example">${escapeHtml(w.example || '')}</div>
          </div>
        </div>
        <div class="wcActions">
          <button class="btn good" data-act="known">â—€ï¸ ì•„ëŠ” ë‹¨ì–´</button>
          <button class="btn bad" data-act="unknown">ëª¨ë¥´ëŠ” ë‹¨ì–´ â–¶ï¸</button>
        </div>
      `;

      card.querySelector('[data-tts="word"]').addEventListener('click', () => speak(w.word));
      card.querySelector('[data-open="example"]').addEventListener('click', () => openModal(w));

      card.querySelector('[data-act="known"]').addEventListener('click', () => commit(w, 'known'));
      card.querySelector('[data-act="unknown"]').addEventListener('click', () => commit(w, 'unknown'));

      initMasking(card);

      attachSwipe(card, {
        onLeft: () => commit(w, 'known'),
        onRight: () => commit(w, 'unknown')
      });

      stack.appendChild(card);
    });

    function commit(word, action){
      if(action === 'known') markKnown(word, dateStr);
      if(action === 'unknown') markUnknown(word, dateStr);

      const top = stack.querySelector('.wordCard');
      if(top){
        top.style.transition = 'transform 220ms ease, opacity 220ms ease';
        const dir = action === 'known' ? -1 : 1;
        top.style.transform = `translateX(${dir*120}%) rotate(${dir*14}deg)`;
        top.style.opacity = '0';
        setTimeout(() => renderDay(dateStr, kind), 180);
      }else{
        renderDay(dateStr, kind);
      }
    }
  }

  function renderUnknown(){
    const ls = langState();
    const langLabel = activeLangMeta().label;
    $('#subtitle').textContent = `${langLabel} Â· ëª¨ë¥´ëŠ” ë‹¨ì–´`;

    const master = getMaster(state.activeLang);
    const items = Object.keys(ls.unknown)
      .map(id => ({ word: master.find(w => w.id === id), meta: ls.unknown[id] }))
      .filter(x => x.word)
      .sort((a,b) => (b.meta.lastSeenAt ?? 0) - (a.meta.lastSeenAt ?? 0));

    $('#view').innerHTML = `
      <div class="card">
        <h2>ëª¨ë¥´ëŠ” ë‹¨ì–´ (${items.length})</h2>
        <p class="sub">ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„(ëª¨ë¥´ëŠ”)ë¡œ ë¶„ë¥˜ëœ ë‹¨ì–´ë“¤ì´ ëª¨ì—¬ìš”. ëœ»ì€ íƒ­í•˜ë©´ ë³´ì—¬.</p>
        ${items.length === 0 ? `<div class="empty">ì•„ì§ ëª¨ë¥´ëŠ” ë‹¨ì–´ê°€ ì—†ì–´. ì˜¤ëŠ˜ ë‹¨ì–´ë¶€í„° ì‹œì‘í•´ë´!</div>` : `
          <div class="toolbar">
            <button class="btn" id="btnUnknownToKnown">ì „ì²´ë¥¼ â€˜ì•„ëŠ” ë‹¨ì–´â€™ë¡œ</button>
            <button class="btn" id="btnClearUnknown">ì „ì²´ ì‚­ì œ</button>
          </div>
          <div class="list" style="margin-top:12px;">${items.map(renderRow('unknown')).join('')}</div>
        `}
      </div>
    `;

    initMasking($('#view'));

    if(items.length){
      $('#btnClearUnknown').addEventListener('click', () => {
        if(!confirm('ëª¨ë¥´ëŠ” ë‹¨ì–´ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')) return;
        ls.unknown = {};
        saveState();
        renderUnknown();
      });
      $('#btnUnknownToKnown').addEventListener('click', () => {
        if(!confirm('ëª¨ë¥´ëŠ” ë‹¨ì–´ ì „ì²´ë¥¼ ì•„ëŠ” ë‹¨ì–´ë¡œ ì˜®ê¸¸ê¹Œìš”?')) return;
        const dateStr = isoDate();
        items.forEach(({word}) => markKnown(word, dateStr));
        saveState();
        renderUnknown();
      });

      $$('[data-row-open="example"]').forEach(el => {
        el.addEventListener('click', () => {
          const id = el.dataset.id;
          const w = master.find(x => x.id === id);
          if(w) openModal(w);
        });
      });

      $$('[data-row-act="unknown-to-known"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const w = master.find(x => x.id === id);
          if(!w) return;
          markKnown(w, isoDate());
          saveState();
          renderUnknown();
        });
      });
      $$('[data-row-act="unknown-remove"]').forEach(btn => {
        btn.addEventListener('click', () => unmark(btn.dataset.id, 'unknown'));
      });
    }
  }

  function renderKnown(){
    const ls = langState();
    const langLabel = activeLangMeta().label;
    $('#subtitle').textContent = `${langLabel} Â· ì•„ëŠ” ë‹¨ì–´`;

    const master = getMaster(state.activeLang);
    const dueIds = getRewindDueIds();

    const items = Object.keys(ls.known)
      .map(id => ({ word: master.find(w => w.id === id), meta: ls.known[id] }))
      .filter(x => x.word)
      .sort((a,b) => (b.meta.lastReviewedAt ?? 0) - (a.meta.lastReviewedAt ?? 0));

    $('#view').innerHTML = `
      <div class="card">
        <h2>ì•„ëŠ” ë‹¨ì–´ (${items.length})</h2>
        <p class="sub">ì™¼ìª½ ìŠ¤ì™€ì´í”„(ì•„ëŠ”)ë¡œ ë¶„ë¥˜ëœ ë‹¨ì–´ë“¤ì´ ëª¨ì—¬ìš”. ëœ»ì€ ê¸°ë³¸ ìˆ¨ê¹€(íƒ­í•˜ë©´ í‘œì‹œ). <b>${ls.settings.rewindDays}ì¼</b>ë§ˆë‹¤ ë¦¬ì™€ì¸ë“œ ëŒ€ìƒì´ ë¼ìš”.</p>

        ${dueIds.length ? `
          <div class="notice">
            ğŸ” ë¦¬ì™€ì¸ë“œ ëŒ€ìƒ: <b>${dueIds.length}</b>ê°œ
          </div>
          <div class="toolbar">
            <button class="btn" id="btnStartRewind">ë¦¬ì™€ì¸ë“œ ì‹œì‘</button>
            <button class="btn" id="btnClearKnown">ì „ì²´ ì‚­ì œ</button>
          </div>
        ` : `
          <div class="toolbar">
            <button class="btn" id="btnClearKnown">ì „ì²´ ì‚­ì œ</button>
            <button class="btn" id="btnGoToday">ì˜¤ëŠ˜ì˜ ë‹¨ì–´</button>
          </div>
        `}

        ${items.length === 0 ? `<div class="empty">ì•„ëŠ” ë‹¨ì–´ê°€ ì•„ì§ ì—†ì–´. ì˜¤ëŠ˜ ë‹¨ì–´ì—ì„œ ì™¼ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ í•´ë´!</div>` : `
          <div class="list" style="margin-top:12px;">${items.map(renderRow('known', new Set(dueIds))).join('')}</div>
        `}
      </div>
    `;

    initMasking($('#view'));

    $('#btnClearKnown')?.addEventListener('click', () => {
      if(!confirm('ì•„ëŠ” ë‹¨ì–´ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?')) return;
      ls.known = {};
      saveState();
      renderKnown();
    });
    $('#btnGoToday')?.addEventListener('click', () => setRoute('today'));

    $('#btnStartRewind')?.addEventListener('click', () => startRewind(dueIds));

    $$('[data-row-open="example"]').forEach(el => {
      el.addEventListener('click', () => {
        const id = el.dataset.id;
        const w = master.find(x => x.id === id);
        if(w) openModal(w);
      });
    });

    $$('[data-row-act="known-to-unknown"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.id;
        const w = master.find(x => x.id === id);
        if(!w) return;
        markUnknown(w, isoDate());
        delete ls.known[id];
        saveState();
        renderKnown();
      });
    });
    $$('[data-row-act="known-remove"]').forEach(btn => {
      btn.addEventListener('click', () => unmark(btn.dataset.id, 'known'));
    });
  }

  function startRewind(dueIds){
    const master = getMaster(state.activeLang);
    const ls = langState();

    const list = dueIds.map(id => master.find(w => w.id === id)).filter(Boolean);
    if(list.length === 0){ alert('ë¦¬ì™€ì¸ë“œ ëŒ€ìƒì´ ì—†ì–´ìš”.'); return; }

    let idx = 0;
    const dateStr = isoDate();

    function renderRewindCard(){
      const w = list[idx];
      $('#view').innerHTML = `
        <div class="card">
          <h2>ë¦¬ì™€ì¸ë“œ</h2>
          <p class="sub">${idx+1} / ${list.length} Â· ë³µìŠµ í›„ ë‹¤ì‹œ ë¶„ë¥˜í•´ì¤˜.</p>
          <div class="stack" style="height:420px;">
            <div class="wordCard" id="rewindCard" style="position:relative;">
              <div>
                <div class="wcTop">
                  <div class="wcIndex">ë¦¬ì™€ì¸ë“œ</div>
                  <div class="wcHint">â—€ï¸ ì•„ëŠ” ë‹¨ì–´<br/>â–¶ï¸ í—·ê°ˆë¦¼</div>
                </div>
                <div class="wcMain">
                  <div class="wcWordRow">
                    <h3 class="wcWord">${escapeHtml(w.word)}</h3>
                    <button class="ttsBtn" id="rwSpeak">ğŸ”Š</button>
                  </div>
                  <div class="wcIpa">${escapeHtml(w.ipa || '')}</div>
                  <div class="wcKo">ë°œìŒ(í•œê¸€): ${escapeHtml(w.koPron || '-')}</div>
                  <div class="wcMeaning">ëœ»: ${escapeHtml(w.meaningKo || '-')}</div>
                  <div class="wcExample" id="rwExample">${escapeHtml(w.example || '')}</div>
                </div>
              </div>
              <div class="wcActions">
                <button class="btn good" id="rwKnown">â—€ï¸ ì—¬ì „íˆ ì•</button>
                <button class="btn bad" id="rwUnknown">í—·ê°ˆë¦¼ â–¶ï¸</button>
              </div>
            </div>
          </div>
          <div class="toolbar">
            <button class="btn" id="rwExit">ë‚˜ê°€ê¸°</button>
          </div>
        </div>
      `;

      const card = $('#rewindCard');
      $('#rwSpeak').addEventListener('click', () => speak(w.word));
      $('#rwExample').addEventListener('click', () => openModal(w));

      $('#rwKnown').addEventListener('click', () => commit('known'));
      $('#rwUnknown').addEventListener('click', () => commit('unknown'));
      $('#rwExit').addEventListener('click', () => setRoute('known'));

      attachSwipe(card, {
        onLeft: () => commit('known'),
        onRight: () => commit('unknown')
      });

      function commit(action){
        if(action === 'known'){
          ls.known[w.id] ??= { firstAt: now(), lastReviewedAt: now(), fromDate: dateStr };
          ls.known[w.id].lastReviewedAt = now();
        }
        if(action === 'unknown'){
          markUnknown(w, dateStr);
          delete ls.known[w.id];
        }
        saveState();

        card.style.transition = 'transform 220ms ease, opacity 220ms ease';
        const dir = action === 'known' ? -1 : 1;
        card.style.transform = `translateX(${dir*120}%) rotate(${dir*14}deg)`;
        card.style.opacity = '0';

        setTimeout(() => {
          idx++;
          if(idx >= list.length) setRoute('known');
          else renderRewindCard();
        }, 180);
      }
    }

    renderRewindCard();
  }

  function renderSettings(){
    const ls = langState();
    const langLabel = activeLangMeta().label;
    $('#subtitle').textContent = `${langLabel} Â· ì„¤ì •`;

    const currentCustom = loadCustomMaster(state.activeLang);
    const sample = JSON.stringify([
      {"word":"resilient","ipa":"/rÉªËˆzÉªliÉ™nt/","koPron":"ë¦¬ì§ˆë¦¬ì–¸íŠ¸","meaningKo":"íšŒë³µíƒ„ë ¥ì ì¸","example":"She is resilient in difficult times."}
    ], null, 2);

    $('#view').innerHTML = `
      <div class="grid">
        <div class="card">
          <h2>ë‹¨ì–´ ì¶”ê°€</h2>
          <p class="sub">í˜„ì¬ ì–¸ì–´(${escapeHtml(langLabel)}) ë‹¨ì–´ëª©ë¡ì— ë°”ë¡œ ì¶”ê°€ë¼.</p>
          <div style="display:grid; gap:10px;">
            <input id="addWord" placeholder="ë‹¨ì–´ (ì˜ˆ: account / ç¢ºèª / cuenta)" />
            <input id="addIpa" placeholder="ë°œìŒê¸°í˜¸/ì½ê¸° (ì˜ˆ: /É™ËˆkaÊŠnt/ , ã‹ãã«ã‚“)" />
            <input id="addKoPron" placeholder="ë°œìŒ(í•œê¸€) (ì˜ˆ: ì–´ì¹´ìš´íŠ¸)" />
            <input id="addMeaning" placeholder="ëœ»(í•œêµ­ì–´) (ì˜ˆ: ê³„ì •)" />
            <input id="addExample" placeholder="ì˜ˆë¬¸ (í´ë¦­ ì‹œ ìƒì„¸+TTS)" />
          </div>
          <div class="toolbar">
            <button class="btn" id="btnAdd">ì¶”ê°€</button>
            <button class="btn" id="btnExport">ë‚´ë³´ë‚´ê¸°(JSON)</button>
          </div>
          <div class="toolbar">
            <button class="btn" id="btnImport">ë¶ˆëŸ¬ì˜¤ê¸°(JSON)</button>
            <button class="btn" id="btnUseBuiltIn">ê¸°ë³¸ ë‹¨ì–´ë¡œ ë˜ëŒë¦¬ê¸°</button>
          </div>
          <p class="small">* â€˜ì¶”ê°€â€™ë¥¼ í•œ ìˆœê°„ë¶€í„° ì´ ì–¸ì–´ì˜ ì˜¤ëŠ˜ ë‹¨ì–´ì— í¬í•¨ë  ìˆ˜ ìˆì–´. (30ì¼ í”Œëœì€ ëª©ë¡/ê°œìˆ˜ì— ë”°ë¼ ìë™ ìƒì„±)</p>
        </div>

        <div class="card">
          <h2>ë¦¬ì™€ì¸ë“œ ì£¼ê¸°</h2>
          <p class="sub">ì•„ëŠ” ë‹¨ì–´ë¥¼ ëª‡ ì¼ë§ˆë‹¤ ë¦¬ì™€ì¸ë“œí• ì§€ ì„¤ì •í•´.</p>
          <div class="toolbar">
            <button class="btn" data-days="7">7ì¼</button>
            <button class="btn" data-days="5">5ì¼</button>
            <button class="btn" data-days="3">3ì¼</button>
          </div>
          <p class="small">í˜„ì¬: <b id="rwDays">${ls.settings.rewindDays}</b>ì¼</p>
        </div>

        <div class="card">
          <h2>ì˜¤ëŠ˜ ë‹¨ì–´ ê°œìˆ˜</h2>
          <p class="sub">ë©”ì¸/ì˜¤ëŠ˜ í˜ì´ì§€ì— í‘œì‹œí•  ì˜¤ëŠ˜ì˜ ë‹¨ì–´ ê°œìˆ˜.</p>
          <div class="toolbar">
            <button class="btn" data-count="10">10</button>
            <button class="btn" data-count="20">20</button>
            <button class="btn" data-count="30">30</button>
          </div>
          <p class="small">í˜„ì¬: <b id="dailyCount">${ls.settings.dailyCount}</b>ê°œ</p>
        </div>

        <div class="card">
          <h2>ì§„í–‰ ê¸°ë¡ ì´ˆê¸°í™”</h2>
          <p class="sub">í˜„ì¬ ì–¸ì–´(${escapeHtml(langLabel)})ì˜ ì•„ëŠ”/ëª¨ë¥´ëŠ”/ì¼ì¼ ê¸°ë¡ì„ ëª¨ë‘ ì§€ì›€.</p>
          <div class="toolbar">
            <button class="btn" id="btnResetProgress">ì´ ì–¸ì–´ë§Œ ì´ˆê¸°í™”</button>
            <button class="btn" id="btnNukeAll">ì „ì²´(3ê°œ ì–¸ì–´) ì´ˆê¸°í™”</button>
          </div>
          <p class="small">ë‹¨ì–´ëª©ë¡(ì»¤ìŠ¤í…€)ë„ ê°™ì´ ì§€ìš°ê³  ì‹¶ìœ¼ë©´ â€˜ì „ì²´ ì´ˆê¸°í™”â€™ë¥¼ ì‚¬ìš©í•´.</p>
        </div>

        <div class="card">
          <h2>í˜„ì¬ ë‹¨ì–´ëª©ë¡ ìƒíƒœ</h2>
          <p class="sub">ì»¤ìŠ¤í…€ ì‚¬ìš© ì¤‘: <b>${currentCustom ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤(ê¸°ë³¸ ë‹¨ì–´)'}</b></p>
          <div class="notice">ì›í•˜ë©´ JSONìœ¼ë¡œ í•œ ë²ˆì— ë¶™ì—¬ë„£ëŠ” ë°©ì‹ë„ ê°€ëŠ¥í•´. (ì•„ë˜ ì˜ˆì‹œ ì°¸ê³ )</div>
          <textarea id="bulkJson" placeholder='ì˜ˆì‹œ:
${escapeHtml(sample)}'></textarea>
          <div class="toolbar">
            <button class="btn" id="btnSaveBulk">ì´ JSONìœ¼ë¡œ ë®ì–´ì“°ê¸°</button>
            <button class="btn" id="btnCopySample">ì˜ˆì‹œ ë³µì‚¬</button>
          </div>
          <div class="toolbar">
            <button class="btn" id="btnRebuildPlan">30ì¼ í”Œëœ ë‹¤ì‹œ ë§Œë“¤ê¸°</button>
            <button class="btn" id="btnTryLoadFile">íŒŒì¼ ë‹¨ì–´íŒ© ë‹¤ì‹œ ì½ê¸°</button>
          </div>
          <p class="small">íŒŒì¼ì€ ê°™ì€ í´ë”ì˜ <b>${escapeHtml(activeLangMeta().defaultFile)}</b>ë¥¼ ì½ì–´ì™€.</p>
        </div>
      </div>
    `;

    // add
    $('#btnAdd').addEventListener('click', () => {
      const w = $('#addWord').value.trim();
      const example = $('#addExample').value.trim();
      if(!w){ alert('ë‹¨ì–´ë¥¼ ì…ë ¥í•´ì¤˜.'); return; }
      if(!example){ alert('ì˜ˆë¬¸ì„ ì…ë ¥í•´ì¤˜.'); return; }

      const item = {
        id: `u_${state.activeLang}_${now()}_${hashId(w)}`,
        word: w,
        ipa: $('#addIpa').value.trim(),
        koPron: $('#addKoPron').value.trim(),
        meaningKo: $('#addMeaning').value.trim(),
        example
      };

      const base = loadCustomMaster(state.activeLang) ?? getMaster(state.activeLang);
      const next = base.concat([item]);
      saveCustomMaster(state.activeLang, next);

      // í”Œëœ ë¦¬ì…‹(ë‹¨ì–´ ì¶”ê°€ë˜ë©´ ë‹¤ì‹œ êµ¬ì„±)
      langState().plan = null;
      saveState();

      // clear
      $('#addWord').value = '';
      $('#addIpa').value = '';
      $('#addKoPron').value = '';
      $('#addMeaning').value = '';
      $('#addExample').value = '';

      alert('ì¶”ê°€í–ˆì–´!');
    });

    // export
    $('#btnExport').addEventListener('click', async () => {
      const list = loadCustomMaster(state.activeLang) ?? getMaster(state.activeLang);
      const json = JSON.stringify(list, null, 2);
      try{
        await navigator.clipboard.writeText(json);
        alert('í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆì–´. ë©”ëª¨/ë…¸íŠ¸ì— ë¶™ì—¬ë„£ê¸° í•´ë‘ë©´ ë°±ì—… ì™„ë£Œ!');
      }catch{
        $('#bulkJson').value = json;
        alert('ì•„ë˜ í…ìŠ¤íŠ¸ë°•ìŠ¤ì— ë‚´ë³´ëƒˆì–´. ë³µì‚¬í•´ì„œ ì €ì¥í•´ì¤˜.');
      }
    });

    // import (paste prompt)
    $('#btnImport').addEventListener('click', () => {
      const raw = prompt('ë¶ˆëŸ¬ì˜¬ JSONì„ ë¶™ì—¬ë„£ì–´ì¤˜ (ë°°ì—´ í˜•íƒœ)');
      if(!raw) return;
      try{
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed) || parsed.length === 0) throw new Error('bad');
        saveCustomMaster(state.activeLang, parsed);
        langState().plan = null; // í”Œëœ ë¦¬ì…‹
        saveState();
        alert('ë¶ˆëŸ¬ì™”ì–´! ìƒˆë¡œê³ ì¹¨ ì—†ì´ ë°”ë¡œ ì ìš©ë¼.');
        setRoute('settings');
      }catch{
        alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„.');
      }
    });

    // bulk save
    $('#btnSaveBulk').addEventListener('click', () => {
      const raw = $('#bulkJson').value.trim();
      if(!raw){ alert('JSONì´ ë¹„ì–´ ìˆì–´ìš”.'); return; }
      try{
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed) || parsed.length === 0) throw new Error('bad');
        saveCustomMaster(state.activeLang, parsed);
        langState().plan = null; // í”Œëœ ë¦¬ì…‹
        saveState();
        alert('ë®ì–´ì“°ê¸° ì™„ë£Œ!');
        setRoute('settings');
      }catch{
        alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„.');
      }
    });

    $('#btnCopySample').addEventListener('click', async () => {
      const t = sample;
      try{ await navigator.clipboard.writeText(t); alert('ì˜ˆì‹œë¥¼ ë³µì‚¬í–ˆì–´.'); }
      catch{ $('#bulkJson').value = t; alert('ë³µì‚¬ ì‹¤íŒ¨: ì•„ë˜ ì¹¸ì— ì˜ˆì‹œë¥¼ ë„£ì–´ë’€ì–´.'); }
    });

    $('#btnUseBuiltIn').addEventListener('click', () => {
      if(!confirm('ì´ ì–¸ì–´ì˜ ì»¤ìŠ¤í…€ ë‹¨ì–´ëª©ë¡ì„ ì§€ìš°ê³  ê¸°ë³¸ ë‹¨ì–´ë¡œ ë˜ëŒë¦´ê¹Œìš”?')) return;
      localStorage.removeItem(LS_CUSTOM_MASTER_PREFIX + state.activeLang);
      langState().plan = null;
      saveState();
      alert('ê¸°ë³¸ ë‹¨ì–´ë¡œ ë˜ëŒë ¸ì–´.');
      setRoute('settings');
    });

    // rebuild plan button
    $('#btnRebuildPlan').addEventListener('click', () => {
      langState().plan = null;
      saveState();
      alert('30ì¼ í”Œëœì„ ë‹¤ìŒ í™”ë©´ë¶€í„° ìƒˆë¡œ ë§Œë“¤ê²Œ í–ˆì–´.');
    });

    // try load file pack again (manual)
    $('#btnTryLoadFile').addEventListener('click', async () => {
      // ê°•ì œë¡œ íŒŒì¼ë¡œ ë®ì–´ì“°ê³  ì‹¶ìœ¼ë©´ ë¨¼ì € í˜„ì¬ ì»¤ìŠ¤í…€ì„ ì§€ìš°ëŠ” ê²Œ ì•ˆì „
      if(!confirm('íŒŒì¼ ë‹¨ì–´íŒ©ì„ ë‹¤ì‹œ ì½ì„ê¹Œìš”? (í˜„ì¬ ì»¤ìŠ¤í…€ì´ ìˆìœ¼ë©´ ë®ì–´ì“°ì§€ ì•ŠìŒ)')) return;
      const changed = await loadDefaultPackIfMissing(state.activeLang);
      alert(changed ? 'íŒŒì¼ì—ì„œ ê¸°ë³¸ ë‹¨ì–´íŒ©ì„ ì½ì–´ì™”ì–´!' : 'ì½ì–´ì˜¬ íŒŒì¼ì´ ì—†ê±°ë‚˜, ì´ë¯¸ ì»¤ìŠ¤í…€ ë‹¨ì–´ê°€ ìˆì–´ìš”.');
      setRoute('settings');
    });

    // rewindDays
    $$('[data-days]').forEach(btn => btn.addEventListener('click', () => {
      ls.settings.rewindDays = Number(btn.dataset.days);
      saveState();
      $('#rwDays').textContent = String(ls.settings.rewindDays);
      alert(`ë¦¬ì™€ì¸ë“œ ì£¼ê¸°ë¥¼ ${ls.settings.rewindDays}ì¼ë¡œ ì„¤ì •í–ˆì–´.`);
    }));

    // dailyCount
    $$('[data-count]').forEach(btn => btn.addEventListener('click', () => {
      ls.settings.dailyCount = Number(btn.dataset.count);
      langState().plan = null; // ê°œìˆ˜ ë°”ë€Œë©´ í”Œëœ ë‹¤ì‹œ ìƒì„±
      saveState();
      $('#dailyCount').textContent = String(ls.settings.dailyCount);
      alert(`ì˜¤ëŠ˜ ë‹¨ì–´ ê°œìˆ˜ë¥¼ ${ls.settings.dailyCount}ê°œë¡œ ì„¤ì •í–ˆì–´.`);
    }));

    // reset progress (current language)
    $('#btnResetProgress').addEventListener('click', () => {
      if(!confirm(`í˜„ì¬ ì–¸ì–´(${langLabel})ì˜ ì§„í–‰ ê¸°ë¡ì„ ì´ˆê¸°í™”í• ê¹Œìš”?`)) return;
      const keep = ls.settings;
      state.langs[state.activeLang] = defaultLangState();
      state.langs[state.activeLang].settings = keep;
      saveState();
      alert('ì´ˆê¸°í™”í–ˆì–´.');
      setRoute('home');
    });

    // nuke all
    $('#btnNukeAll').addEventListener('click', () => {
      if(!confirm('ì „ì²´(3ê°œ ì–¸ì–´) ì§„í–‰+ë‹¨ì–´ëª©ë¡ê¹Œì§€ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
      localStorage.removeItem(LS_KEY);
      Object.keys(LANGS).forEach(l => localStorage.removeItem(LS_CUSTOM_MASTER_PREFIX + l));
      alert('ì „ì²´ ì´ˆê¸°í™”í–ˆì–´. ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì²˜ìŒ ìƒíƒœë¡œ ëŒì•„ê°€.');
    });
  }

  function renderRow(type, dueSet){
    return ({word, meta}) => {
      const last = type === 'known' ? (meta.lastReviewedAt ?? 0) : (meta.lastSeenAt ?? 0);
      const lastStr = last ? `${daysBetween(last, now())}ì¼ ì „` : 'ê¸°ë¡ ì—†ìŒ';
      const isDue = dueSet?.has(word.id);

      const actions = type === 'unknown'
        ? `<div style="display:flex; gap:8px; margin-top:6px;">
            <button class="btn" data-row-act="unknown-to-known" data-id="${word.id}">âœ… ì•„ëŠ” ë‹¨ì–´ë¡œ</button>
            <button class="btn" data-row-act="unknown-remove" data-id="${word.id}">ğŸ—‘ï¸ ì‚­ì œ</button>
          </div>`
        : `<div style="display:flex; gap:8px; margin-top:6px;">
            <button class="btn" data-row-act="known-to-unknown" data-id="${word.id}">â“ ë‹¤ì‹œ ëª¨ë¥´ëŠ” ë‹¨ì–´ë¡œ</button>
            <button class="btn" data-row-act="known-remove" data-id="${word.id}">ğŸ—‘ï¸ ì‚­ì œ</button>
          </div>`;

      return `
        <div class="row">
          <div class="rowTop">
            <div>
              <div class="rowWord">${escapeHtml(word.word)} ${isDue ? `<span class="badge" style="margin-left:8px; background: rgba(61,220,151,.16); border-color: rgba(61,220,151,.38);">ë¦¬ì™€ì¸ë“œ</span>` : ''}</div>
              <div class="rowIpa">${escapeHtml(word.ipa || '')}</div>
              <div class="rowKo">ë°œìŒ(í•œê¸€): ${escapeHtml(word.koPron || '-')}</div>
            </div>
            <div class="rowMeta">${type === 'known' ? 'ë§ˆì§€ë§‰ ë³µìŠµ' : 'ë§ˆì§€ë§‰ í™•ì¸'}: ${lastStr}</div>
          </div>
          <div class="rowMeaning mask" data-mask="meaning">ëœ»: ${escapeHtml(word.meaningKo || '-')}</div>
          <div class="rowEx" data-row-open="example" data-id="${word.id}">${escapeHtml(word.example || '')}</div>
          ${actions}
        </div>
      `;
    };
  }

  // ---------- Mask + Swipe helper ----------
  function initMasking(root=document){
    const els = root.querySelectorAll?.('[data-mask]') ?? [];
    els.forEach(el => {
      if(!el.classList.contains('mask')) el.classList.add('mask');
      if(el.dataset.bound === '1') return;
      el.dataset.bound = '1';
      el.addEventListener('click', (e) => {
        e.stopPropagation();
        el.classList.toggle('revealed');
      });
    });
  }

  function attachSwipe(el, {onLeft, onRight}){
    let startX = 0;
    let startY = 0;
    let dragging = false;

    const threshold = 60;
    const maxTilt = 12;

    function onPointerDown(e){
      const p = getPoint(e);
      startX = p.x;
      startY = p.y;
      dragging = true;
      el.style.transition = 'none';
    }

    function onPointerMove(e){
      if(!dragging) return;
      const p = getPoint(e);
      const dx = p.x - startX;
      const dy = p.y - startY;
      if(Math.abs(dy) > Math.abs(dx) && Math.abs(dy) > 10) return;

      const tilt = Math.max(-maxTilt, Math.min(maxTilt, dx / 18));
      el.style.transform = `translateX(${dx}px) rotate(${tilt}deg)`;
      el.style.opacity = String(1 - Math.min(0.55, Math.abs(dx)/420));
    }

    function onPointerUp(e){
      if(!dragging) return;
      dragging = false;
      const p = getPoint(e);
      const dx = p.x - startX;
      const dy = p.y - startY;

      if(Math.abs(dx) >= threshold && Math.abs(dx) > Math.abs(dy)){
        if(dx < 0) onLeft?.();
        else onRight?.();
        return;
      }

      el.style.transition = 'transform 180ms ease, opacity 180ms ease';
      el.style.transform = 'translateX(0) rotate(0)';
      el.style.opacity = '1';
    }

    el.addEventListener('pointerdown', onPointerDown, {passive:true});
    window.addEventListener('pointermove', onPointerMove, {passive:true});
    window.addEventListener('pointerup', onPointerUp, {passive:true});
    window.addEventListener('pointercancel', onPointerUp, {passive:true});

    function getPoint(e){ return { x: e.clientX, y: e.clientY }; }
  }

  // ---------- Nav ----------
  $$('.nav button').forEach(b => b.addEventListener('click', () => setRoute(b.dataset.route)));

  // hash routes
  function syncHash(){
    const h = location.hash.replace('#','').trim();
    if(h && routes[h]) setRoute(h);
  }
  window.addEventListener('hashchange', syncHash);

  // âœ… ì•± ì‹œì‘: ê¸°ë³¸íŒ© ë¡œë“œ(ìˆìœ¼ë©´) â†’ í™”ë©´ ë Œë”
  // ì˜ì–´ë§Œ ë¨¼ì €ë¼ë©´ vocab_en.jsonë§Œ ìˆì–´ë„ ë¨.
  await loadDefaultPackIfMissing('en');
  await loadDefaultPackIfMissing('ja');
  await loadDefaultPackIfMissing('es');

  syncHash();
  if(!location.hash) setRoute('home');

})();
</script>
</body>
</html>
